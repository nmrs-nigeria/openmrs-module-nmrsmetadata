<htmlform formUuid="5f217cca-75c7-49be-a559-f9714d3d0bd7" formName="Maternal Cohort Register"
          formEncounterType="990a8120-8402-47fd-b256-4a1fb9bcbeaf" formVersion="2018">
    <!-- Autogenerated example form  (template from 01-Nov-2010 -->
    <macros>
        paperFormId = (Fill this in) headerColor =#2f1c55 fontOnHeaderColor = white
    </macros>

    <style>
        .section {
            border: 1px solid $headerColor;
            padding: 2px;
            text-align: left;
            margin-bottom: 1em;
        }

        .error {
            color: red;
        }

        .sectionHeader {
            background-color: $headerColor;
            color: $fontOnHeaderColor;
            display: block;
            padding: 2px;
            font-weight: bold;
        }

        table.baseline-aligned td {
            vertical-align: baseline;
        }

        form select,
        .form select {
            max-width: 250px;
        }

        form input,
        form select,
        form ul.select,
        .form input,
        .form select,
        .form ul.select {
            max-width: 250px;
        }
    </style>
    <script type="text/javascript">
        jQuery(function () {

            jQuery('.datefield').find("input").attr("readonly", true);
            jQuery('.hasDatepicker').attr('readonly', true)

        });
    </script>

    <script type="text/javascript">

        var $ = jQuery;
        $(document).ready(function(){

            beforeSubmit.push(function (e) {

                let dsdstatus = document.querySelector('#dsdstatus').children[0];
                let service_delivery_model = document.querySelector('#service_delivery_model').children[0];
                let community_based = document.querySelector('#community_based').children[0];
                let facility_based = document.querySelector('#facility_based').children[0];

                if (dsdstatus.value == "") {
                    dsdstatus.focus();
                    getField('dsdstatus.error').html('Ensure this field is not empty').show();
                    return false;
                } else if (dsdstatus.value == "167128"){
                    return true;
                }

                if (dsdstatus.value == "167127") {

                    if (service_delivery_model.value == "") {
                        service_delivery_model.focus();

                        getField('service_delivery_model.error').html('Ensure this field is not empty').show();
                        return false;
                    } else if (service_delivery_model.value == "166276") {

                        getField('service_delivery_model.error').hide();


                        if (facility_based.value == "") {
                            facility_based.focus();
                            getField('facility_based.error').html('Ensure this field is not empty').show();
                            return false;
                        } else {
                            getField('facility_based.error').hide();
                            return true;

                        }
                    } else if (service_delivery_model.value == "166363") {

                        getField('service_delivery_model.error').hide();

                        if (community_based.value == "") {

                            community_based.focus();
                            getField('community_based.error').html('Ensure this field is not empty').show();
                            return false;
                        } else {
                            getField('community_based.error').hide();
                            return true;

                        }
                    }
                }
            });

        })

    </script>



    <span style="float:right">Paper Form ID: $paperFormId</span>

    <h2>Maternal Cohort Register </h2>
    <section headerLabel="Encounter Information" style="width: 80%; margin-left: 10%;">
        <table style="width: 95%; margin-left: 2%;">
            <tr>
                <td>Visit Date</td>
                <td>
                    <encounterDate default="today" class="datefield" showTime="false" allowFutureDates="false" />
                </td>
            </tr>
            <tr>
                <td>Health Facility</td>
                <td>
                    <encounterLocation default="SessionAttribute:emrContext.sessionLocationId" />
                </td>
            </tr>
            <tr>
                <td>Service Provider</td>
                <td>
                    <encounterProviderAndRole default="currentUser" encounterRole="240b26f9-dd88-4172-823d-4a8bfeb7841f"
                                              required="true" />
                </td>
            </tr>
        </table>
    </section>

    <section headerLabel="Clinical Summary">
        <table id="dashboard" cellspacing="10" cellpadding="5" align="center">
            <tr>
                <td><b>Name:</b>
                    <lookup expression="patient.personName.givenName" />
                    <lookup expression="patient.personName.familyName" />
                </td>
                <td><b>ANC No:</b>
                    <lookup expression="patient.getPatientIdentifier(6)" />
                </td>
                <td><b>Hospital Number:</b>
                    <lookup expression="patient.getPatientIdentifier(5)" />&#160;&#160;<b>Age: </b>
                    <lookup expression="patient.age" />
                </td>
            </tr>
            <tr>
                <td><b>Weight:</b>
                    <font color='blue' style="font-weight: bold">
                        <lookup expression="fn.latestObs('5089').valueNumeric" />
                    </font>kg
                    <lookup expression="fn.latestObs('5089').obsDatetime" />
                </td>
                <td><b>Height:</b>
                    <font color='blue' style="font-weight: bold">
                        <lookup expression="fn.latestObs('5090').valueNumeric" />
                    </font> cm
                    <lookup expression="fn.latestObs('5090').obsDatetime" />
                </td>
                <td><b>CD4 Count:</b>
                    <font color='blue' style="font-weight: bold">
                        <lookup expression="fn.latestObs('5497').valueNumeric" />
                    </font> c/mm <sup>3</sup>
                    <lookup expression="fn.latestObs('5497').obsDatetime" />
                </td>
            </tr>
            <tr>
                <td><b>Viral Load:</b>
                    <font color='blue' style="font-weight: bold">
                        <lookup expression="fn.latestObs('856').valueNumeric" />
                    </font>copies/ml
                    <lookup expression="fn.latestObs('856').obsDatetime" />
                </td>
                <td><b>Regimen:</b></td>
                <td><b>ART Start Date:</b>
                    <font color='blue' style="font-weight: bold">
                        <lookup expression="fn.latestObs(159599).getValueDatetime()" />
                    </font>
                </td>
            </tr>
            <tr>
                <td><b>Entry Point:</b>
                    <font color='blue' style="font-weight: bold">
                        <lookup expression="fn.latestObs('166025').valueNumeric" />
                    </font>
                    <lookup expression="fn.latestObs('166025').obsDatetime" />
                </td>
                <td><b>Date of Delivery:</b>
                    <font color='blue' style="font-weight: bold">
                        <lookup expression="fn.latestObs(5599).valueDatetime" />
                    </font>
                </td>
                <td><b>Timing of ART Initiation:</b>
                    <font color='blue' style="font-weight: bold">
                        <lookup expression="fn.latestObs(165518).valueCoded.name" />
                    </font>
                </td>
            </tr>
            <!-- calculation for ARV Refill (html start) -->
            <tr>
                <td><b>Last Date of ARV Refill:</b>
                    <font color='blue' style="font-weight: bold">
                        <!-- the concept name for (159368) is medication duration  -->
                        <lookup expression="fn.latestObs(159368).obsDatetime" />
                    </font>
                </td>
                <td><b>Days of ARV Refill:</b>
                    <font color='blue' style="font-weight: bold">
                        <lookup expression="fn.latestObs(159368).valueNumeric" />
                    </font>
                </td>
                <td><b>Days of ARVs Left:</b>
                    <font color='blue' style="display: none" id="daysOfARVRefillDifference">
                        <lookup expression="fn.latestObs(159368).obsDatetime" />
                    </font>
                    <font style="font-weight: bold" id="daysOfARVLeft">
                        <lookup expression="fn.latestObs(159368).valueNumeric" />
                    </font><br />
                    <b>Date of Next Refill: </b>
                    <font style="font-weight: bold" id="dateOfNextRefill"></font>
                </td>
            </tr>
            <!-- calculation for ARV Refill (html end) 165090 -->


        </table>
    </section>

    <script>
        // calculation for ARV Refill (js start)
        // Get the date string from the lookup tag
        const lookupTag = document.querySelector('#daysOfARVRefillDifference');
        const dateString = lookupTag.textContent;

        // Convert the date string to a Date object
        const targetDate = new Date(dateString);

        // Calculate the difference in days between the target date and the current date
        const today = new Date();
        const timeDiff = today.getTime() - targetDate.getTime();
        const daysDifference = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

        // Get the value numeric from the lookup tag
        const daysOfARVLeft = document.querySelector('#daysOfARVLeft');
        const valueNumeric = parseFloat(daysOfARVLeft.textContent);

        // Subtract the days difference from the value numeric
        const newValueNumeric = valueNumeric - daysDifference;

        // Update the content of the value tag with the new value
        if (Math.sign(newValueNumeric) === 1) {
            daysOfARVLeft.textContent = newValueNumeric;
            daysOfARVLeft.style.color = "green";
        } else if (Math.sign(newValueNumeric) === -1) {
            daysOfARVLeft.textContent = newValueNumeric;
            daysOfARVLeft.style.color = "red";
        }

        // Calculate the Date of Next ARVs Refill
        const dateOfNextRefillTag = document.querySelector('#dateOfNextRefill');
        const dateOfNextRefillValue = new Date(today.getTime() + newValueNumeric * 24 * 60 * 60 * 1000);
        const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        console.log(dateOfNextRefillValue);
        console.log(today);
        if (dateOfNextRefillValue > today) {
            dateOfNextRefillTag.textContent = dateOfNextRefillValue.toLocaleDateString('en-US', options);
            dateOfNextRefillTag.style.color = "green";
        } else {
            dateOfNextRefillTag.textContent = dateOfNextRefillValue.toLocaleDateString('en-US', options);
            dateOfNextRefillTag.style.color = "red";
        }

        // calculation for ARV Refill (js end)
    </script>



    <section headerLabel="Clinical Information">
        <table>
            <tr>
                <td>
                    Timing of ART Initiation :
                    <obs conceptId="165518" answerConceptIds="165519,165520,165521,164850,1180" answerLabels="Prior to this pregnancy, Initiated ART during pregnancy &#60; 36 weeks gestation period,
Initiated ART during pregnancy &#8805; 36 weeks gestation period,
Initiated ART at L&#38;D, Initiated ART after delivery (post-partum)" />
                </td>

                <td>
                    TB Status :
                    <obs conceptId="1659" answerConceptIds="1660,142177,166042,1661,1662"
                         answerLabels="No signs or symptoms of TB not on IPT, Presumptive TB, IPT, Confirmed TB, TB treatment"
                         required="true" />
                </td>

            </tr>

            <tr>
                <td>
                    Date of Delivery :
                    <obs conceptId="5599" class="datefield" allowFutureDates="true" />

                </td>
                <td>
                    FP Counselling :
                    <obs id="fpcounselling" conceptId="1382" answerLabels="No,Yes" answerConceptIds="1066,1065">
                        <when value="1065" thenDisplay="#fpmethod" />
                    </obs>
                </td>
                <td>
                    FP Method
                    <span id="fpmethod">
                        <obs conceptId="374" answerConceptIds="1107,190,780,5279,159589,136452,5622"
                             answerLabels="No FP Method,Condom,Oral Pills,Injectable, Implant,IUD,Other" />
                    </span>
                </td>
            </tr>
        </table>
    </section>
    <section headerLabel="Viral Load Information 21,22,23">
        <table>
            <tr>
                <td>Viral Load Period </td>
                <td colspan='2'>
                    <obs id="viralloadperiod" conceptId="166124" answerConceptIds="166122,166123" answerLabels="Viral Load -
At 32-36 weeks GA,Viral Load Other -
 At any time point during PMTCT ">
                        <controls>
                            <when value="166122" thenDisplay="#viralload32to36" />
                            <when value="166123" thenDisplay="#viralloadothers" />

                        </controls>
                    </obs>
                </td>
            </tr>
            <tr>
                <th>Sample Collection Date</th>
                <th>GA at VL Collection (Weeks)</th>
                <th>Result (copies/ML) or Enter 0 for TND </th>
            </tr>
            <tr id="viralload32to36">
                <td>
                    <obs conceptId="159951" class="datefield" />
                </td>
                <td>
                    <obs conceptId="166125" />
                </td>
                <td>
                    <obs conceptId="166122" />
                </td>
            </tr>
            <tr id="viralloadothers">
                <td>
                    <obs conceptId="159951" class="datefield" />
                </td>
                <td>
                    <obs conceptId="166125" />
                </td>
                <td>
                    <obs conceptId="166123" />
                </td>
            </tr>
        </table>
    </section>



    <!-- DSD section -->
    <section headerLabel="24. DSD Model">

        <table>
            <tr>
                <td class="alnleft_s">DSD Status</td>
                <td class="alnleft_s">
                    <obs id="dsdstatus" conceptId="167126" answerConceptIds="167127,167128" answerLabels="Devolved,Not Devolved" required="true">
                        <controls>
                            <when value="167127" thenDisplay="#devolved" />
                        </controls>
                    </obs>
                </td>

                <!--  <td class="alnleft_s">
                      <table id="DSDstartDate" class="table">
                          <tr>

                          </tr>
                      </table>
                  </td>  -->
            <tr id="devolved" >
                <td class="alnleft_s">Dispensing Modality</td>
                <td class="alnleft_s">
                    <obs id="service_delivery_model" conceptId="166148" answerConceptIds="166276,166363" answerLabels="Facility Dispensing, Community Dispensing">
                        <controls>
                            <when value="166276" thenDisplay="#Facility_Dispensing" />
                            <when value="166363" thenDisplay="#ddd_Dispensing" />
                        </controls>
                    </obs>
                </td>
                <td>
                    <table  class="table" width="100%">
                        <tr id="Facility_Dispensing">
                            <td>Facility Dispensing </td>
                            <td >

                                <obs id="facility_based" conceptId='166276' answerConceptIds="166151,167107,167108,167109,167110,167111,167112,167112,167165" answerLabels="Fast Track, Facility ART group HCW led,Facility ART group Support group,Decentralization (Hub and Spoke),After hours,Weekend and Public holidays,Child/Teen/Adolescents club (Peer Managed),Mother infant pair/Mentor mother led,Out of school clinic hours managed by HCWs" />
                            </td>
                            <!--                            <td>DSD Start Date</td>-->
                            <!--                            <td>-->
                            <!--                                <obs id="f_dsd_date" conceptId="167129" />-->
                            <!--                            </td>-->
                        </tr>
                    </table>
                </td>

                <td>
                    <table  class="table" width="100%">
                        <tr id="ddd_Dispensing">
                            <td>Community Dispensing </td>
                            <td >

                                <obs id="community_based" conceptId='166363' answerConceptIds="166134,166135,167113,167166,167167,167168,167169,167170,167114,167115,166280,167124,167171" answerLabels="Community Pharmacy, Community ART Group (HCW-led), Community ART Refill Group (PLHIV-led), Community ART Refill Group: Non HCW/Non PLHIV led peer-led, Distribution group managed by Adolescents Peer, Ad-hoc healthcare worker-led in conflict prone areas, Cluster drug refill, PHC devolvement, Adolescent Community ART/ peer-led groups, One Stop Shop (OSS), Home/Courier Delivery,Mother infant pair/Mentor mother led, School-Based Clinics" />
                            </td>
                            <!--                            <td>DSD Start Date</td>-->
                            <!--                            <td>-->
                            <!--                                <obs id="c_dsd_date" conceptId="167129" />-->
                            <!--                            </td>-->
                        </tr>
                    </table>
                </td>
            </tr>
            </tr>
        </table>
    </section>

    <!--    <section headerLabel="DSD Model">-->
    <!--        <table>-->
    <!--            <tr>-->
    <!--                <td class="alnleft_s">DSD Status</td>-->
    <!--                <td class="alnleft_s"><obs conceptId="167126" answerConceptIds="167127,167128" answerLabels="Devolved,Not Devolved"/></td>-->

    <!--                &lt;!&ndash;  <td class="alnleft_s">-->
    <!--                      <table id="DSDstartDate" class="table">-->
    <!--                          <tr>-->

    <!--                          </tr>-->
    <!--                      </table>-->
    <!--                  </td>  &ndash;&gt;-->

    <!--                <td class="alnleft_s">Dispensing Modality</td>-->
    <!--                <td class="alnleft_s">-->
    <!--                    <obs id="ServiceDeliveryModel" conceptId="166148" answerConceptIds="166276,166363" answerLabels="Facility Dispensing, Decentralized Drug Delivery (DDD)">-->
    <!--                        <controls>-->
    <!--                            <when value="166276" thenDisplay="#Facility_Dispensing" />-->
    <!--                            <when value="166363" thenDisplay="#ddd_Dispensing" />-->
    <!--                        </controls>-->
    <!--                    </obs>-->
    <!--                </td>-->
    <!--                <td>-->
    <!--                    <table  class="table" width="100%">-->
    <!--                        <tr id="Facility_Dispensing">-->
    <!--                            <td>Facility Dispensing </td>-->
    <!--                            <td >-->

    <!--                                <obs conceptId='166276' answerConceptIds="166153,166151,167107,167108,167109,167110,167111,167112,167112" answerLabels="Not Differenciated, Fast Track, Facility ART group HCW led,Facility ART group Support group,Decentralization (Hub and Spoke),After hours,Weekend and Public holidays,Child/Teen/Adolescents club (Peer Managed),Mother infant pair/Mentor mother led" />-->
    <!--                            </td>-->
    <!--                       &lt;!&ndash;     <td>DSD Start Date</td>-->
    <!--                            <td>-->
    <!--                                <obs  conceptId="167129" />-->
    <!--                            </td>   &ndash;&gt;-->
    <!--                        </tr>-->
    <!--                    </table>-->
    <!--                </td>-->

    <!--                <td>-->
    <!--                    <table  class="table" width="100%">-->
    <!--                        <tr id="ddd_Dispensing">-->
    <!--                            <td>Community Dispensing (DDD)</td>-->
    <!--                            <td >-->

    <!--                                <obs conceptId='166363' answerConceptIds="166134,166135,167113,167114,167115,166280" answerLabels="Community Pharmacy, Community ART Group (HCW-led), Community ART Refill Group (PLHIV-led), Adolescent Community ART/ peer-led groups, One Stop Shop (OSS), Home/Courier Delivery" />-->
    <!--                            </td>-->
    <!--                       &lt;!&ndash;     <td>DSD Start Date</td>-->
    <!--                            <td>-->
    <!--                                <obs  conceptId="167129" />-->
    <!--                            </td>  &ndash;&gt;-->
    <!--                        </tr>-->
    <!--                    </table>-->
    <!--                </td>-->
    <!--            </tr>-->
    <!--        </table>-->
    <!--    </section>-->

    <section headerLabel="25. Health Facility Visits">
        <table>
            <tr>
                <td style="width: 20%;">Visit Status
                    <obs conceptId="166129" answerConceptIds="166126,167174,160563,159492,166127,166128,160031,5240,160432"
                         answerLabels="Active in PMTCT cohort, Still Breastfeeding, Transferred In, Transferred Out, Transferred to another PMTCT cohort (new pregnancy)
, Transitioned to ART clinic, Missed Appointment/Defaulted (assign at end of month)
, Lost to follow-up, Dead " />
                </td>
                <td>Regimen Line
                    <obs id="regimenline" conceptId="165708" answerConceptIds="164506,164513,165702">
                        <controls>
                            <when value="164506" thenDisplay="#adult_first_line" />
                            <when value="164513" thenDisplay="#adult_second_line" />
                            <when value="165702" thenDisplay="#adult_salvage" />
                        </controls>
                    </obs>
                </td>
                <td>Regimen <span id="adult_first_line">
                        <obs conceptId="164506" />
                    </span><span id="adult_second_line">
                        <obs conceptId="164513" />
                    </span><span id="adult_salvage">
                        <obs conceptId="165702" />
                    </span>
                </td>
            </tr>
        </table>
    </section>

    <section headerLabel="FINAL OUTCOME">
        <table>
            <tr>
                <td>Maternal Outcome
                    <obs conceptId="166516" toggle="{id: 'end', style: 'dim'}"
                         answerConceptIds="166126,160563,166127,166128,5240,160432"
                         answerLabels="A = Active in PMTCT Cohort, TO = Transferred Out, TP = Transferred to another PMTCT Cohort (new Pregnancy), TA = Transitioned to ART Clinic, LTFU = Lost to follow-up, D = Dead" />
                </td>
                <td>Date
                    <obs conceptId="166008" class="datefield" />
                </td>
                <td>Comments
                    <obs conceptId="165045" />
                </td>
            </tr>
            <tr id="end">
                <td>
                    <completeProgram programId="2" />
                </td>
            </tr>
        </table>
    </section>

    <submit />

</htmlform>